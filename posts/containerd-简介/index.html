<!doctype html><html lang=zh>
<head>
<title>Containerd ç®€ä»‹ | easystack</title>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="containerd å…¥é—¨ç¯‡">
<meta name=generator content="Hugo 0.88.1">
<meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel=stylesheet href=/css/style.css>
<link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon>
</head>
<body>
<nav class=navigation>
<a href=/> <span class=arrow>â†</span>é¦–é¡µ</a>
<a href=/posts>å½’æ¡£</a>
<a href=/tags>æ ‡ç­¾</a>
<a href=/about>å…³äº</a>
<a class=button href=https://easystack.github.io/index.xml>è®¢é˜…</a>
</nav>
<main class=main>
<section id=single>
<h1 class=title>Containerd ç®€ä»‹</h1>
<div class=tip>
<time datetime="2021-10-09 15:50:43 +0800 +0800">2021å¹´10æœˆ09æ—¥</time>
<span class=split>
Â·
</span>
<span>
3823å­—
</span>
<span class=split>
Â·
</span>
<span>
8åˆ†é’Ÿ
</span>
</div>
<aside class=toc>
<details>
<summary>Table of Contents
</summary>
<div>
<nav id=TableOfContents>
<ul>
<li><a href=#diff-æ’ä»¶>diff æ’ä»¶</a></li>
<li><a href=#scheduler>scheduler</a></li>
<li><a href=#monitor>monitor</a></li>
<li><a href=#cgroup>cgroup</a></li>
<li><a href=#runtime-v1>runtime v1</a></li>
<li><a href=#runtime-v2>runtime v2</a></li>
<li><a href=#snapshot>snapshot</a></li>
</ul>
<ul>
<li><a href=#container-image-lease-namespace-æœåŠ¡>container, image, lease, namespace æœåŠ¡ï¼š</a></li>
<li><a href=#content-æœåŠ¡>content æœåŠ¡</a></li>
<li><a href=#task-æœåŠ¡>task æœåŠ¡</a></li>
<li><a href=#diff-æœåŠ¡>diff æœåŠ¡:</a></li>
<li><a href=#eventæœåŠ¡>eventæœåŠ¡ï¼š</a></li>
<li><a href=#introspection-æœåŠ¡>introspection æœåŠ¡:</a></li>
<li><a href=#healthcheck-æœåŠ¡>healthcheck æœåŠ¡ï¼š</a></li>
<li><a href=#versionæœåŠ¡>versionæœåŠ¡ï¼š</a></li>
<li><a href=#optæœåŠ¡>optæœåŠ¡ï¼š</a></li>
<li><a href=#server>server</a></li>
</ul>
</nav>
</div>
</details>
</aside>
<div class=content>
<h1 id=å†å²>å†å² <a href=#%e5%8e%86%e5%8f%b2 class=anchor>ğŸ”—</a></h1><ul>
<li>Docker Daemonä»æœ€åˆé›†æˆåœ¨dockerå‘½ä»¤ä¸­ï¼ˆ1.11ç‰ˆæœ¬å‰ï¼‰ï¼Œ</li>
<li>ç‹¬ç«‹æˆå•ç‹¬äºŒè¿›åˆ¶ç¨‹åºï¼ˆ1.11ç‰ˆæœ¬å¼€å§‹ï¼‰2016.12
<ul>
<li>containerdæ˜¯å®¹å™¨æŠ€æœ¯æ ‡å‡†åŒ–ä¹‹åçš„äº§ç‰©ï¼Œä¸ºäº†èƒ½å¤Ÿå…¼å®¹OCIæ ‡å‡†ï¼Œä»Docker Daemonå‰¥ç¦»</li>
<li>containerdåˆ†v0.2.x ï¼Œ v1.xç‰ˆæœ¬
<ul>
<li>v0.2.x ç”±docker daemoné›†æˆ</li>
<li>v1.x å¼€å§‹æ”¯æŒociæ ‡å‡†</li>
</ul>
</li>
<li>containerdé¡¹ç›®åœ°å€ï¼š github.com/docker/containerd</li>
</ul>
</li>
<li>containerdæçŒ®ç»™cncf 2017.03
<ul>
<li>é¡¹ç›®åœ°å€ä¿®æ”¹ä¸º github.com/containerd/containerd</li>
<li>v1.0.0æ­£å¼ç‰ˆå‘å¸ƒ 2017.12 æ”¯æŒOCIæ¥å£</li>
<li>v1.1.0æ­£å¼ç‰ˆ 2018.4 æ”¯æŒCRIæ¥å£</li>
<li>v1.2.0æ­£å¼ç‰ˆ 2018.10 runtime v2ç¨³å®š</li>
</ul>
</li>
<li>shim
<ul>
<li>shimæ˜¯ä¸€ä¸ªçœŸå®è¿è¡Œçš„å®¹å™¨çš„çœŸå®è½½ä½“</li>
</ul>
</li>
</ul>
<h1 id=æ¶æ„>æ¶æ„ <a href=#%e6%9e%b6%e6%9e%84 class=anchor>ğŸ”—</a></h1><ul>
<li>ç»„ä»¶å¦‚å›¾</li>
</ul>
<p><p class=markdown-image>
<img src=/images/containerd-arch.png alt=1>
</p></p>
<h1 id=glossary>glossary <a href=#glossary class=anchor>ğŸ”—</a></h1><ul>
<li>
<p>æœåŠ¡ï¼š æä¾›grpcæœåŠ¡</p>
</li>
<li>
<p>sandboxï¼šä¸€ç§ç‰¹æ®Šå®¹å™¨ï¼Œä¸»è¦ä½œç”¨å‡†å¤‡å®¹å™¨éš”ç¦»çš„ç¯å¢ƒï¼ŒåŒ…æ‹¬ç½‘ç»œï¼Œioç›®å½•ï¼Œcgroup parent</p>
</li>
<li>
<p>containerï¼šä¸šåŠ¡å®¹å™¨ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½ç”±ä¸€ä¸ªtask ç®¡ç†</p>
</li>
<li>
<p>shimï¼šç®¡ç†å™¨(containerd) å’Œ runtimeçš„ç²˜å’Œå±‚ï¼Œå› ä¸ºruncæ˜¯äºŒè¿›åˆ¶æ–‡ä»¶æ‰§è¡Œï¼Œæ— æ³•å¸¸é©»å†…å­˜ï¼Œä½¿ç”¨shimä¸€æ–¹é¢æ–¹ä¾¿ç®¡ç†ï¼Œå¦ä¸€æ–¹é¢æ‰©å±•runtime; shimç®¡ç† sandbox + container(s)</p>
</li>
<li>
<p>taskï¼šä»£è¡¨è¿›ç¨‹+io</p>
</li>
<li>
<p>runtime v2: å¯ä»¥ç†è§£ task ç®¡ç†å™¨</p>
</li>
</ul>
<h1 id=æœåŠ¡>æœåŠ¡ <a href=#%e6%9c%8d%e5%8a%a1 class=anchor>ğŸ”—</a></h1><ul>
<li>æ¯ä¸ªæœåŠ¡éƒ½æ˜¯pluginæ–¹å¼åŠ å…¥ï¼ŒåŒ…æ‹¬ä¸é™äºimage, runtime, grpc serverç­‰</li>
<li>pluginç‰¹ç‚¹
<ul>
<li>æ’ä»¶URIä¸º Type+IDï¼Œå¦‚ <code>io.containerd.snapshotter.v1.overlayfs</code>ï¼Œio.containerd.snapshotter.v1æ˜¯Typeï¼Œoverlayfsæ˜¯ID</li>
<li>æ’ä»¶ç±»å‹ä¹‹é—´æœ‰ä¾èµ–, ä»ä¸‹å‘ä¸Šæ’åºï¼š
<ul>
<li>ContentPluginï¼Œ SnapshotPlugin</li>
<li>MetadataPlugin</li>
<li>GCPluginï¼ŒRuntimePluginï¼ŒDiffPlugin</li>
<li>ServicePlugin</li>
<li>InternalPluginï¼ŒGRPCPlugin</li>
</ul>
</li>
</ul>
</li>
<li>æ•°æ®ç»“æ„</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>classDiagram
    class Meta{
        +&#39;ocispec.Platform&#39; Platforms
        +&#39;map[string]string&#39; Exports
        +string[] Capabilities
    }
    class Plugin{
        +Registration Registration
        +Meta Meta
        +string[] Requires
        +object Config
        +Err() error
        +Instance() (object, error)
    }
    class Registration{
        +string Type
        +string ID
        +string[] Requires
        +object Config
        +Init(context) Plugin
        +URI() string
    }


</code></pre></div><h2 id=diff-æ’ä»¶>diff æ’ä»¶ <a href=#diff-%e6%8f%92%e4%bb%b6 class=anchor>ğŸ”—</a></h2><ul>
<li>ç”¨äºsnaphostçš„æ“ä½œ</li>
<li>diff/walking/pluginç›®å½•ï¼Œ DiffPluginç±»å‹ï¼Œä¾èµ–MetadataPlugin</li>
<li>æä¾›ä¸¤ä¸ªæ–¹æ³•
<ul>
<li><code>Compare</code> æ ¹æ®æä¾›çš„ lowerï¼Œupper ä¿¡æ¯ï¼Œå¾—åˆ°oscispec.Descriptor</li>
<li><code>Apply</code> ä»é•œåƒå‹ç¼©æ–‡ä»¶ä¸­è¯»å–å†…å®¹ï¼Œå¹¶æŒ‰åºæ‰§è¡Œå¤šä¸ªå¤„ç†å™¨ï¼Œä¸»è¦æ˜¯æ ¡éªŒï¼Œè§£å‹ï¼Œè‡ªå®šä¹‰æ’ä»¶ç­‰</li>
</ul>
</li>
</ul>
<h2 id=scheduler>scheduler <a href=#scheduler class=anchor>ğŸ”—</a></h2><ul>
<li>è°ƒåº¦å™¨ï¼Œgc/schedulerç›®å½•ï¼Œ GCPluginç±»å‹ï¼Œä¾èµ–MetadataPlugin</li>
<li>é…ç½®ä¿¡æ¯
<ul>
<li>PauseThreshold: æš‚åœé˜ˆå€¼ï¼Œå¹³å‡æ¯ç§’2%çš„æš‚åœæ—¶é—´ï¼Œä½¿ç”¨è¯¥å€¼è®¡ç®—ä¸‹æ¬¡ç­‰å¾…å‘¨æœŸï¼Œé»˜è®¤ä¸º0.02, æœ€å¤§å€¼0.5</li>
<li>DeletionThresholdï¼šåˆ é™¤é˜ˆå€¼ï¼Œåœ¨åˆ é™¤å¤šå°‘æ¬¡ä¹‹åè‡³å°‘ä¿è¯å‘ç”Ÿgcè°ƒåº¦ï¼Œ0è¡¨ç¤ºä¸ä¼šè¢«åˆ é™¤è§¦å‘ï¼Œé»˜è®¤0</li>
<li>MutationThresholdï¼š çªå˜é˜ˆå€¼</li>
<li>ScheduleDelayï¼šè°ƒåº¦å»¶è¿Ÿï¼Œå½“å‘ç”Ÿæ‰‹åŠ¨è§¦å‘æˆ–è€…é˜ˆå€¼è§¦å‘åï¼Œå»¶è¿Ÿå¤šä¹…æ‰å¼€å§‹GCï¼Œé»˜è®¤0ms</li>
<li>StartupDelayï¼š æ…¢å¯åŠ¨ï¼Œé»˜è®¤100ms</li>
</ul>
</li>
<li>goroutine
<ul>
<li>gcå®é™…æ˜¯æ‰§è¡Œcontent.GarbageCollect</li>
</ul>
</li>
</ul>
<h2 id=monitor>monitor <a href=#monitor class=anchor>ğŸ”—</a></h2><ul>
<li>å®¹å™¨çš„èµ·åœçŠ¶æ€åŒæ­¥ï¼Œ InternalPluginç±»å‹ï¼Œä¾èµ–ServicePlugin</li>
<li>goroutine
<ul>
<li>è¿‡æ»¤æ ‡ç­¾ <code>containerd.io/restart.status</code>çš„container</li>
<li>å¯¹æ¯”containerå’Œé¢„æœŸçŠ¶æ€æ˜¯å¦ç›¸ç¬¦</li>
<li>é‡æ–°æ‰§è¡Œstartæˆ–stop</li>
</ul>
</li>
</ul>
<h2 id=cgroup>cgroup <a href=#cgroup class=anchor>ğŸ”—</a></h2><ul>
<li>è¿›ç¨‹oomç›‘å¬å’ŒæŒ‡æ ‡ç»Ÿè®¡ï¼Œåœ¨ metrics/cgroup ç›®å½•ï¼Œ TaskMonitorPluginç±»å‹</li>
<li>ä½œç”¨ï¼štaskçš„æŒ‡æ ‡å’Œoomç›‘å¬</li>
<li>ä¸»è¦æ˜¯shim åœ¨ä½¿ç”¨è¯¥æ¨¡å—ï¼Œshiméœ€è¦ç›‘å¬ task æ˜¯å¦å‘ç”ŸOOM</li>
</ul>
<h2 id=runtime-v1>runtime v1 <a href=#runtime-v1 class=anchor>ğŸ”—</a></h2><ul>
<li>å®¹å™¨è¿›ç¨‹ç®¡ç†å™¨,ï¼Œ RuntimePluginç±»å‹ï¼Œä¾èµ–MetadataPlugin</li>
<li>é…ç½®
<ul>
<li>shimï¼š shimäºŒè¿›åˆ¶æ–‡ä»¶åœ°å€</li>
<li>runtimeï¼š è¢«shimä½¿ç”¨çš„runtimeäºŒè¿›åˆ¶æ–‡ä»¶åœ°å€</li>
<li>no_shimï¼š ç›´æ¥è°ƒç”¨runtimeï¼Œè·³è¿‡shim</li>
<li>shim_debugï¼š æ˜¯å¦æ‰“å¼€shimè°ƒè¯•</li>
</ul>
</li>
</ul>
<h2 id=runtime-v2>runtime v2 <a href=#runtime-v2 class=anchor>ğŸ”—</a></h2><ul>
<li>å®¹å™¨è¿›ç¨‹ç®¡ç†å™¨, RuntimePluginV2ç±»å‹ï¼Œä¾èµ–MetadataPlugin</li>
<li>åœ¨<a href=https://github.com/containerd/containerd/blob/34fb8d8967595292adce04b53b12ee33499cd6b8/client.go#L102 target=_blank rel=noopener>client</a>ä¸­è¢«é…ç½®ä¸ºé»˜è®¤çš„runtime</li>
<li>åˆå§‹åŒ–æ—¶ä¼šæ‰§è¡Œä»¥ä¸‹å†…å®¹
<ul>
<li>åˆ›å»ºç›®å½• {root/state}/io.containerd.runtime.v2.task</li>
<li>è¯»å– {state}/io.containerd.runtime.v2.taskç›®å½•</li>
<li>æ¢å¤shim ç®¡ç†</li>
</ul>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>tipsï¼š
fifoæ–‡ä»¶roæ‰“å¼€ï¼šå½“æ— å†™ç«¯ï¼Œè‹¥æ˜¯nonblockingæ¨¡å¼ï¼Œåˆ™è¿”å›ï¼Œå¦åˆ™é˜»å¡
fifoæ–‡ä»¶woæ‰“å¼€ï¼šå½“æ— è¯»ç«¯ï¼Œè¿”å›ENXIOï¼Œè‹¥è¯»ç«¯å…³é—­æ—¶å†™æ•°æ®ï¼Œåˆ™è¿”å›SIGPIPE
fifoæ–‡ä»¶rwæ‰“å¼€ï¼šæ€»æ˜¯æˆåŠŸ
</code></pre></div><h2 id=snapshot>snapshot <a href=#snapshot class=anchor>ğŸ”—</a></h2><ul>
<li>å®¹å™¨çš„rootfsç®¡ç†å™¨ï¼ŒSnapshotPluginç±»å‹</li>
<li>linux å¹³å°
<ul>
<li>snapshots/{native, overlay, devmapperï¼Œbtrfs}</li>
<li>containerd/{aufs,zfs}</li>
</ul>
</li>
<li>windowså¹³å°
<ul>
<li>snapshots/{lcow, windows}</li>
</ul>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#080;font-style:italic># man 8 mount</span>
<span style=color:#080;font-style:italic># references: https://wiki.archlinux.org/title/Overlay_filesystem</span>
tips:
<span style=color:#666>1</span> overlay æŒ‚è½½
mount -t overlay  overlay -o <span style=color:#b8860b>lowerdir</span><span style=color:#666>=</span>/lower:/lower2,upperdir<span style=color:#666>=</span>/upper,workdir<span style=color:#666>=</span>/work  /merged
// upperdir ä¸€èˆ¬æ˜¯å¯å†™å±‚
// workdir ç©ºç›®å½•ï¼Œ
<span style=color:#666>2</span> devmapper æŒ‚è½½
mount -t ext4 /dev/mapper/xx <span style=color:#666>{</span>target<span style=color:#666>}</span>
<span style=color:#666>3</span> native æŒ‚è½½
mount -t <span style=color:#a2f>bind</span> <span style=color:#666>{</span>src<span style=color:#666>}</span> <span style=color:#666>{</span>dst<span style=color:#666>}</span>
<span style=color:#666>4</span> btrfs 
mount -t btrfs 
</code></pre></div><h1 id=services>services <a href=#services class=anchor>ğŸ”—</a></h1><ul>
<li>æä¾›rpcæœåŠ¡å’Œæ•°æ®åº“æ“ä½œç­‰</li>
<li>services/ç›®å½•ä¸‹ï¼Œå…·ä½“æœ‰ä»¥ä¸‹çš„å†…å®¹</li>
</ul>
<h2 id=container-image-lease-namespace-æœåŠ¡>container, image, lease, namespace æœåŠ¡ï¼š <a href=#container-image-lease-namespace-%e6%9c%8d%e5%8a%a1 class=anchor>ğŸ”—</a></h2><ul>
<li>local.go: æ˜¯service Pluginç±»å‹ï¼Œå¯¹æ•°æ®åº“çš„æ“ä½œï¼Œä»¥åŠeventçš„å‘é€</li>
<li>service.go: æ˜¯grpc Pluginç±»å‹ï¼Œæä¾›grpcæœåŠ¡ï¼Œå¹¶ä½¿ç”¨localå†…ç›¸åŒæ¥å£</li>
</ul>
<h2 id=content-æœåŠ¡>content æœåŠ¡ <a href=#content-%e6%9c%8d%e5%8a%a1 class=anchor>ğŸ”—</a></h2><ul>
<li>service.go: æä¾›grpcæœåŠ¡ï¼ŒCRUD contentæ•°æ®</li>
<li>contentserver : contentå…·ä½“æ“ä½œ(content)</li>
</ul>
<h2 id=task-æœåŠ¡>task æœåŠ¡ <a href=#task-%e6%9c%8d%e5%8a%a1 class=anchor>ğŸ”—</a></h2><ul>
<li>local.go: è°ƒç”¨runtime v2åŒåæ¥å£ï¼ŒåŒ…æ‹¬å®¹å™¨åˆ›å»ºï¼Œå¼€å§‹ï¼Œç»“æŸï¼Œåˆ é™¤ï¼Œç»ˆç«¯ï¼ŒçŠ¶æ€ç­‰ä¿¡æ¯</li>
<li>server.go: æä¾›grpcæœåŠ¡</li>
</ul>
<h2 id=diff-æœåŠ¡>diff æœåŠ¡: <a href=#diff-%e6%9c%8d%e5%8a%a1 class=anchor>ğŸ”—</a></h2><ul>
<li>local.go: ä½¿ç”¨diffæ’ä»¶</li>
<li>service.go: æä¾›grpcæœåŠ¡</li>
</ul>
<h2 id=eventæœåŠ¡>eventæœåŠ¡ï¼š <a href=#event%e6%9c%8d%e5%8a%a1 class=anchor>ğŸ”—</a></h2><ul>
<li>service.go: æä¾›grpcæœåŠ¡ï¼ŒåŒ…æ‹¬è½¬å‘ï¼Œæ¨é€ï¼Œè®¢é˜…åŠŸèƒ½</li>
</ul>
<h2 id=introspection-æœåŠ¡>introspection æœåŠ¡: <a href=#introspection-%e6%9c%8d%e5%8a%a1 class=anchor>ğŸ”—</a></h2><ul>
<li>service.go: æä¾›grpcæœåŠ¡ï¼Œåˆ—ä¸¾æ³¨å†Œçš„plugin</li>
</ul>
<h2 id=healthcheck-æœåŠ¡>healthcheck æœåŠ¡ï¼š <a href=#healthcheck-%e6%9c%8d%e5%8a%a1 class=anchor>ğŸ”—</a></h2><ul>
<li>service.go: æä¾› grpcæœåŠ¡ï¼Œæ£€æŸ¥æŒ‡å®šæœåŠ¡çš„å¥åº·</li>
</ul>
<h2 id=versionæœåŠ¡>versionæœåŠ¡ï¼š <a href=#version%e6%9c%8d%e5%8a%a1 class=anchor>ğŸ”—</a></h2><ul>
<li>service.go: æä¾› grpcæœåŠ¡ï¼Œæ£€æŸ¥containerd version</li>
</ul>
<h2 id=optæœåŠ¡>optæœåŠ¡ï¼š <a href=#opt%e6%9c%8d%e5%8a%a1 class=anchor>ğŸ”—</a></h2><ul>
<li>é…ç½®ç›®å½• root
<ul>
<li>æ·»åŠ  {root}/bin åˆ°ç¯å¢ƒå˜é‡ PATHä¸­</li>
<li>æ·»åŠ  {root}/lib åˆ°ç¯å¢ƒå˜é‡LD_LIBRARY_PATHä¸­</li>
</ul>
</li>
</ul>
<h2 id=server>server <a href=#server class=anchor>ğŸ”—</a></h2><ul>
<li>åŸºç¡€pluginï¼Œæ‰©å±•æ’ä»¶çš„åˆå§‹åŒ–å’ŒæœåŠ¡å¯åŠ¨
<ul>
<li>æµç¨‹
<ul>
<li>æ³¨å†Œ ContentPluginæ’ä»¶</li>
<li>æ³¨å†Œ MetadataPluginæ’ä»¶</li>
<li>æ³¨å†Œ proxyæ’ä»¶(ContentPluginæˆ–SnapshotPluginç±»å‹)</li>
<li>æ³¨å†ŒDiffPluginæ’ä»¶ (stream processorç±»å‹)ï¼Œç›®å‰ä¸»è¦æ˜¯å¤„ç† åŠ å¯†çš„é•œåƒ</li>
</ul>
</li>
<li>ç›‘å¬eventç±»å‹
<ul>
<li>/tasks/oom</li>
<li>/images/</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>version = <span style=color:#666>2</span>
root = <span style=color:#b44>&#34;/var/lib/mycontainerd&#34;</span> <span style=color:#080;font-style:italic>#æŒä¹…åŒ–ç›®å½•</span>
state = <span style=color:#b44>&#34;/var/run/mycontainerd&#34;</span> <span style=color:#080;font-style:italic>#éæŒä¹…åŒ–ç›®å½•</span>
oom_score = <span style=color:#666>0</span> <span style=color:#080;font-style:italic># containerdçš„oomåˆ†æ•°</span>
...
[proxy_plugins]
  [proxy_plugins.stargz]
    type = <span style=color:#b44>&#34;snapshot&#34;</span> <span style=color:#080;font-style:italic>#æ”¯æŒsnapshotå’Œcontentç±»å‹</span>
    address = <span style=color:#b44>&#34;/run/containerd-stargz-grpc/containerd-stargz-grpc.sock&#34;</span>
[stream_processors]
  [stream_processors.<span style=color:#b44>&#34;io.containerd.ocicrypt.decoder.v1.tar.gzip&#34;</span>]
    accepts = [<span style=color:#b44>&#34;application/vnd.oci.image.layer.v1.tar+gzip+encrypted&#34;</span>]
    returns = <span style=color:#b44>&#34;application/vnd.oci.image.layer.v1.tar+gzip&#34;</span>
    path = <span style=color:#b44>&#34;/usr/local/bin/ctd-decoder&#34;</span>

[cgroup]
  path = <span style=color:#b44>&#34;&#34;</span> <span style=color:#080;font-style:italic># containerd æ‰€åœ¨è·¯å¾„ï¼Œå»é™¤ â€˜/sys/fs/cgroup/&#39;å‰ç¼€çš„</span>
[plugins]
  [plugins.<span style=color:#b44>&#34;io.containerd.gc.v1.scheduler&#34;</span>]
    pause_threshold = <span style=color:#666>0.02</span>
    deletion_threshold = <span style=color:#666>0</span>
    mutation_threshold = <span style=color:#666>100</span>
    schedule_delay = <span style=color:#b44>&#34;0s&#34;</span>
    startup_delay = <span style=color:#b44>&#34;100ms&#34;</span>
  [plugins.<span style=color:#b44>&#34;io.containerd.internal.v1.restart&#34;</span>]
    interval = <span style=color:#b44>&#34;10s&#34;</span> <span style=color:#080;font-style:italic>#restartæ’ä»¶ï¼Œéå†containerçš„å‘¨æœŸ</span>
  [plugins.<span style=color:#b44>&#34;io.containerd.metadata.v1.bolt&#34;</span>]
    content_sharing_policy = <span style=color:#b44>&#34;shared&#34;</span> <span style=color:#080;font-style:italic>#contentç­–ç•¥ï¼Œsharedåˆ™æ‰€æœ‰ä¸åŒnsçš„éƒ½å¯ä»¥è®¿é—®ï¼Œå¦ä¸€ç§æ˜¯isolated</span>
  [plugins.<span style=color:#b44>&#34;io.containerd.monitor.v1.cgroups&#34;</span>]
    no_prometheus = <span style=color:#a2f;font-weight:700>false</span>
  [plugins.<span style=color:#b44>&#34;io.containerd.runtime.v1.linux&#34;</span>]
    shim = <span style=color:#b44>&#34;containerd-shim&#34;</span>
    runtime = <span style=color:#b44>&#34;runc&#34;</span>
    runtime_root = <span style=color:#b44>&#34;&#34;</span>
    no_shim = <span style=color:#a2f;font-weight:700>false</span>
    shim_debug = <span style=color:#a2f;font-weight:700>false</span>
  [plugins.<span style=color:#b44>&#34;io.containerd.runtime.v2.task&#34;</span>]
    platforms = [<span style=color:#b44>&#34;linux/amd64&#34;</span>] <span style=color:#080;font-style:italic>#é•œåƒæ”¯æŒçš„å¹³å°ç±»å‹</span>
  [plugins.<span style=color:#b44>&#34;io.containerd.service.v1.diff-service&#34;</span>]
    default = [<span style=color:#b44>&#34;walking&#34;</span>] <span style=color:#080;font-style:italic>#walkingæ˜¯å†…ç½®çš„diffæ’ä»¶</span>
</code></pre></div><h1 id=cri>cri <a href=#cri class=anchor>ğŸ”—</a></h1><ul>
<li>GRPCPluginç±»å‹ï¼Œä¾èµ–ServicePlugin</li>
<li>ä½œç”¨: æä¾›criæ¥å£ï¼Œ cri å¸¸è§é…ç½®</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>[plugins.cri]
    disable_tcp_service = <span style=color:#a2f;font-weight:700>true</span>
    stream_server_address = <span style=color:#b44>&#34;127.0.0.1&#34;</span> <span style=color:#080;font-style:italic># unix ç›‘å¬åœ°å€</span>
    stream_server_port = <span style=color:#b44>&#34;0&#34;</span> <span style=color:#080;font-style:italic># unix ç›‘å¬ç«¯å£,0æ˜¯éšæœºåˆ†é…</span>
    stream_idle_timeout = <span style=color:#b44>&#34;4h0m0s&#34;</span> <span style=color:#080;font-style:italic>#idleè¿æ¥è¶…æ—¶æ—¶é—´</span>
    enable_selinux = <span style=color:#a2f;font-weight:700>false</span> 
    sandbox_image = <span style=color:#b44>&#34;hub.easystack.io/captain/pause-amd64:3.0&#34;</span>
    stats_collect_period = <span style=color:#666>10</span> <span style=color:#080;font-style:italic>#å•ä½ç§’ï¼ŒsnapshotçŠ¶æ€æ”¶é›†</span>
    systemd_cgroup = <span style=color:#a2f;font-weight:700>false</span> <span style=color:#080;font-style:italic>#åªé€‚ç”¨io.containerd.runtime.v1.linux</span>
    enable_tls_streaming = <span style=color:#a2f;font-weight:700>false</span> <span style=color:#080;font-style:italic># æ˜¯å¦æ”¯æŒtls</span>
    max_container_log_line_size = <span style=color:#666>16384</span> <span style=color:#080;font-style:italic>#å•è¡Œæ—¥å¿—æœ€å¤§byte</span>
    disable_cgroup = <span style=color:#a2f;font-weight:700>false</span> <span style=color:#080;font-style:italic># å½“rootless è¿è¡Œæ—¶ï¼Œéœ€è¦è®¾ç½®ä¸ºtrue</span>
    disable_apparmor = <span style=color:#a2f;font-weight:700>false</span>
    restrict_oom_score_adj = <span style=color:#a2f;font-weight:700>false</span>
    netns_mounts_under_state_dir = <span style=color:#a2f;font-weight:700>false</span> <span style=color:#080;font-style:italic>#å°†net nsè®¾ç½®åˆ°{state}/netnsç›®å½•ä¸‹,è€Œä¸æ˜¯é»˜è®¤çš„/run/netnsä¸‹</span>
    max_concurrent_downloads = <span style=color:#666>3</span>
    unset_seccomp_profile = <span style=color:#b44>&#34;&#34;</span> <span style=color:#080;font-style:italic>#seccompé…ç½®æ–‡ä»¶</span>
    disable_proc_mount = <span style=color:#a2f;font-weight:700>false</span> <span style=color:#080;font-style:italic>#ç¦ç”¨k8s ProcMountï¼Œ å¯¹äºk8s &lt;= 1.11æ—¶ï¼Œå¿…é¡»è®¾ç½®ä¸ºtrue</span>
    
      tolerate_missing_hugetlb_controller = <span style=color:#a2f;font-weight:700>true</span> <span style=color:#080;font-style:italic>#1.5+,å¯¹äºk8s &lt;1.19,ä¸æ”¯æŒé…ç½®hugetlb</span>
      disable_hugetlb_controller = <span style=color:#a2f;font-weight:700>true</span> <span style=color:#080;font-style:italic>#1.5+, é€‚ç”¨äºrootless+cgroupv2+systemd</span>
      ignore_image_defined_volumes = <span style=color:#a2f;font-weight:700>true</span> <span style=color:#080;font-style:italic>#1.5+ï¼Œåˆ›å»ºcontaineræ—¶ï¼Œå¿½ç•¥imageä¸­å®šä¹‰çš„volume</span>
    [plugins.cri.x509_key_pair_streaming] <span style=color:#080;font-style:italic>#stream tlsé…ç½®</span>
      tls_cert_file = <span style=color:#b44>&#34;&#34;</span>
      tls_key_file = <span style=color:#b44>&#34;&#34;</span>
    [plugins.cri.image_decryption] <span style=color:#080;font-style:italic># è§£å¯†é•œåƒï¼Œå‚è€ƒé¡¹ç›® github.com/containerd/imgcrypt</span>
      key_model = none
    [plugins.cri.containerd]
      snapshotter = <span style=color:#b44>&#34;overlayfs&#34;</span> <span style=color:#080;font-style:italic>#ä½¿ç”¨ä½•ç§snapshot</span>
      default_runtime_name = <span style=color:#b44>&#34;runc&#34;</span> <span style=color:#080;font-style:italic>#é»˜è®¤runtimeï¼Œå¿…é¡»å‡ºç°åœ¨åç»­çš„åˆ—è¡¨ä¸­</span>
      no_pivot = <span style=color:#a2f;font-weight:700>false</span> <span style=color:#080;font-style:italic>#åªé€‚ç”¨io.containerd.runtime.v1.linux</span>
        disable_snapshot_annotations = <span style=color:#a2f;font-weight:700>false</span> <span style=color:#080;font-style:italic>#stargz snapshotéœ€è¦é…ç½®</span>
          discard_unpacked_layers = <span style=color:#a2f;font-weight:700>false</span> <span style=color:#080;font-style:italic>#å½“æ‰§è¡Œcontent GCæ—¶ï¼Œæ˜¯å¦å›æ”¶å·²ç»unpackçš„content</span>
      [plugins.cri.containerd.default_runtime] <span style=color:#080;font-style:italic>#è¢«å¼ƒç”¨</span>
        privileged_without_host_devices = <span style=color:#a2f;font-weight:700>false</span> <span style=color:#080;font-style:italic># è®¾ç½®ç‰¹æƒæ¨¡å¼ä¸‹æ—¶ï¼Œæ˜¯å¦æ˜ å°„ä¸»æœºä¸Šè®¾å¤‡åˆ°å®¹å™¨å†…</span>
      [plugins.cri.containerd.untrusted_workload_runtime] <span style=color:#080;font-style:italic>#è¢«å¼ƒç”¨</span>
        privileged_without_host_devices = <span style=color:#a2f;font-weight:700>false</span>
      [plugins.cri.containerd.runtimes]
        [plugins.cri.containerd.runtimes.runc]
          runtime_type = <span style=color:#b44>&#34;io.containerd.runc.v2&#34;</span> <span style=color:#080;font-style:italic>#å°†è¢«ç”¨äºè§£æä¸ºå…·ä½“äºŒè¿›åˆ¶æ–‡ä»¶å</span>
          [plugins.cri.containerd.runtimes.runc.options]
        <span style=color:#080;font-style:italic># NoPivotRoot disables pivot root when creating a container.</span>
            NoPivotRoot = <span style=color:#a2f;font-weight:700>false</span>
        <span style=color:#080;font-style:italic># NoNewKeyring disables new keyring for the container.</span>
            NoNewKeyring = <span style=color:#a2f;font-weight:700>false</span>
        <span style=color:#080;font-style:italic># è®¾ç½®shim cgroupç›®å½•ï¼Œé»˜è®¤æ˜¯å’Œcontainerdä¸€èµ·</span>
            ShimCgroup = <span style=color:#b44>&#34;&#34;</span>
        <span style=color:#080;font-style:italic># è®¾ç½®shim log user id.</span>
            IoUid = <span style=color:#666>0</span>
        <span style=color:#080;font-style:italic># è®¾ç½®shim log group id.</span>
            IoGid = <span style=color:#666>0</span>
        <span style=color:#080;font-style:italic># è®¾ç½®äºŒè¿›åˆ¶æ–‡ä»¶åï¼Œå¦åˆ™å°†ä½¿ç”¨typeå­—æ®µ</span>
            BinaryName = <span style=color:#b44>&#34;&#34;</span>
        <span style=color:#080;font-style:italic># runcçš„ç›®å½•ï¼Œé»˜è®¤ä¸º {state}/runc.</span>
            Root = <span style=color:#b44>&#34;&#34;</span>
        <span style=color:#080;font-style:italic># criu äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„.</span>
            CriuPath = <span style=color:#b44>&#34;&#34;</span>
        <span style=color:#080;font-style:italic># ä½¿ç”¨cgroupçš„systemd é©±åŠ¨ï¼Œæ³¨æ„éœ€è¦å’Œkubeletä¸­åŒæ ·è®¾ç½®</span>
            SystemdCgroup = <span style=color:#a2f;font-weight:700>true</span>
        <span style=color:#080;font-style:italic># CriuImagePath is the criu image path</span>
            CriuImagePath = <span style=color:#b44>&#34;&#34;</span>
        <span style=color:#080;font-style:italic># CriuWorkPath is the criu work path.</span>
            CriuWorkPath = <span style=color:#b44>&#34;&#34;</span>
          privileged_without_host_devices = <span style=color:#a2f;font-weight:700>false</span>
        [plugins.cri.containerd.runtimes.gvisor]
          runtime_type = <span style=color:#b44>&#34;io.containerd.gvisor.v2&#34;</span>
          pod_annotations =[<span style=color:#b44>&#34;&#34;</span>]
          container_annotations = [<span style=color:#b44>&#34;&#34;</span>]
          base_runtime_spec=<span style=color:#b44>&#34;&#34;</span> <span style=color:#080;font-style:italic># æ–‡ä»¶ç»å¯¹è·¯å¾„ï¼Œä¸”å†…å®¹ä¸ºoci runtimeæ–‡ä»¶æ ¼å¼</span>
        [plugins.cri.containerd.runtimes.firecracker]
         runtime_type = <span style=color:#b44>&#34;io.containerd.firecracker.v2&#34;</span>
    [plugins.cri.cni]
      bin_dir = <span style=color:#b44>&#34;/opt/cni/bin&#34;</span>
      conf_dir = <span style=color:#b44>&#34;/etc/cni/net.d&#34;</span>
      max_conf_num = <span style=color:#666>1</span> <span style=color:#080;font-style:italic>#è‹¥æœ‰å¤šä¸ªcnié…ç½®æ–‡ä»¶ï¼Œåˆ™æŒ‰ç…§æ­¤å€¼è°ƒç”¨å¤šä¸ªcnié…ç½®æ–‡ä»¶</span>
    [plugins.cri.registry]
        config_path= <span>/</span>xxx <span style=color:#080;font-style:italic># ç›®å½•ï¼Œè‹¥é…ç½®è¯¥å€¼ï¼Œåˆ™ä»¥ä¸‹å†…å®¹è¢«å¿½ç•¥</span>
      [plugins.cri.registry.configs] <span style=color:#080;font-style:italic>#è¢«å¼ƒç”¨ï¼Œä½¿ç”¨config_pathä»£æ›¿ï¼Œåœ¨1.7åè¢«ç§»é™¤</span>
        [plugins.cri.registry.configs.<span style=color:#b44>&#34;hub.easystack.io&#34;</span>]
          [plugins.cri.registry.configs.<span style=color:#b44>&#34;hub.easystack.io&#34;</span>.tls]
            insecure_skip_verify = <span style=color:#a2f;font-weight:700>true</span>
      [plugins.cri.registry.mirrors] <span style=color:#080;font-style:italic>#è¢«å¼ƒç”¨ï¼Œä½¿ç”¨config_pathä»£æ›¿ï¼Œåœ¨1.7åè¢«ç§»é™¤</span>
        [plugins.cri.registry.mirrors.<span style=color:#b44>&#34;docker.io&#34;</span>]
          endpoint = [<span style=color:#b44>&#34;https://registry-1.docker.io&#34;</span>]
        [plugins.cri.registry.mirrors.<span style=color:#b44>&#34;hub.easystack.io&#34;</span>]
          endpoint = [<span style=color:#b44>&#34;https://hub.easystack.io&#34;</span>]
</code></pre></div><ul>
<li>å…³äºä»“åº“ç›®å½•é…ç½®æ–¹å¼</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>config_path= /opt/mycontainerd/hosts

# ç›®å½•å†…å®¹
.
â”œâ”€â”€ docker.io
â”‚Â Â  â””â”€â”€ hosts.toml
â””â”€â”€ k8s.gcr.io
    â””â”€â”€ hosts.toml

# hosts.tomlå†…å®¹
server = &#34;https://k8s.gcr.io&#34;

[host.&#34;https://k8s.gcr.io&#34;]
  skip_verify = true
  capabilities = [ &#34;pull&#34;, &#34;resolve&#34;, &#34;push&#34; ]
  ca: &#34;&#34; #æ–‡ä»¶è·¯å¾„æˆ–æ–‡ä»¶å†…å®¹
</code></pre></div>
</div>
<div class=tags>
<a href=https://easystack.github.io/tags/container>container</a>
</div>
<div id=comment>
</div>
</section>
</main>
<footer id=footer>
<div id=social>
<a class=symbol href=easystack rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg>
</a>
</div>
<div class=copyright>
Â© Copyright
2021
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg>
</span>
easystack
</div>
<div class=powerby>
Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-cactus-plus>nodejh</a>
</div>
</footer>
</body>
</html>