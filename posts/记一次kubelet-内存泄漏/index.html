<!doctype html><html lang=zh><head><title>è®°ä¸€æ¬¡kubelet å†…å­˜æ³„æ¼ | easystack</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="kubelet memroy leak"><meta name=generator content="Hugo 0.97.3"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><body><nav class=navigation><a href=/><span class=arrow>â†</span>é¦–é¡µ</a>
<a href=/posts>å½’æ¡£</a>
<a href=/tags>æ ‡ç­¾</a>
<a href=/about>å…³äº</a>
<a class=button href=https://easystack.github.io/index.xml>è®¢é˜…</a></nav><main class=main><section id=single><h1 class=title>è®°ä¸€æ¬¡kubelet å†…å­˜æ³„æ¼</h1><div class=tip><time datetime="2021-11-09 15:50:43 +0800 +0800">2021å¹´11æœˆ09æ—¥</time>
<span class=split>Â·</span>
<span>2020å­—</span>
<span class=split>Â·</span>
<span>5åˆ†é’Ÿ</span></div><aside class=toc><details><summary>Table of Contents</summary><div><nav id=TableOfContents><ul><li><a href=#åŸºç¡€>åŸºç¡€</a></li></ul><ul><li><a href=#åŸºç¡€-1>åŸºç¡€</a></li></ul><ul><li><a href=#exec-æµç¨‹>exec æµç¨‹</a></li></ul><ul><li><a href=#ttrpc>ttrpc</a></li></ul></nav></div></details></aside><div class=content><h1 id=èƒŒæ™¯>èƒŒæ™¯ <a href=#%e8%83%8c%e6%99%af class=anchor>ğŸ”—</a></h1><p>ä¸€æ¬¡ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå‘ç° kubelet å†…å­˜è¾¾åˆ°ä¸Š GB ä»¥ä¸Šï¼Œè¿™ä¸ªä¸ç¬¦åˆå¹³å¸¸ä½¿ç”¨æƒ…å†µï¼Œé¦–å…ˆæƒ³åˆ°çš„æ˜¯å†…å­˜æ³„æ¼ï¼Œé‚£ä¹ˆè‚¯å®šä½¿ç”¨ pprof ä»¥åŠè°ƒæŸ¥ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿå†…å­˜æ³„æ¼</p><h1 id=profile>profile <a href=#profile class=anchor>ğŸ”—</a></h1><h2 id=åŸºç¡€>åŸºç¡€ <a href=#%e5%9f%ba%e7%a1%80 class=anchor>ğŸ”—</a></h2><ul><li>cpu <code>/debug/pprof/profile</code>ï¼Œä¸»è¦åˆ†æè€—æ—¶å’Œä¼˜åŒ–ç®—æ³•ï¼Œå¾—åˆ° profile æ–‡ä»¶</li><li>heap: <code>/debug/pprof/heap</code>ï¼ŒæŸ¥çœ‹æ´»åŠ¨å¯¹è±¡çš„å†…å­˜åˆ†é…æƒ…å†µï¼Œå¾—åˆ° profile æ–‡ä»¶</li><li>threadcreate: <code>/debug/pprof/threadcreate</code>, çº¿ç¨‹åˆ›å»ºæ¦‚å†µæŠ¥å‘Šç¨‹åºä¸­å¯¼è‡´åˆ›å»ºæ–°çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹çš„éƒ¨åˆ†</li><li>goroutineï¼š æŠ¥å‘Šæ‰€æœ‰å½“å‰ goroutine çš„å †æ ˆä¿¡æ¯ï¼Œ<strong>æ²¡æœ‰ profile æ–‡ä»¶</strong></li><li>trace: <code>/debug/pprof/trace</code> å½“å‰ç¨‹åºçš„æ‰§è¡Œè·Ÿè¸ªï¼Œgo tool trace ä¸­ä½¿ç”¨</li></ul><h1 id=kubelet>kubelet <a href=#kubelet class=anchor>ğŸ”—</a></h1><p>æŸ¥çœ‹å¹³å°çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œå¦‚ä¸‹
æ³¨ï¼šï¼ˆä»¥ä¸‹æ•°æ®éå½“æ—¶ç¯å¢ƒï¼Œæ˜¯ä¹‹åé‡æ–°å¤ç°åå–çš„ï¼Œæ¯”å‘ç”Ÿæ³„æ¼ç¯å¢ƒè¦ä½çš„å¤š)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># top</span>
</span></span><span style=display:flex><span>  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
</span></span><span style=display:flex><span><span style=color:#666>31599</span> root      <span style=color:#666>20</span>   <span style=color:#666>0</span> <span style=color:#666>2877396</span> 983.5m  <span style=color:#666>66424</span> S   4.3  6.2  28:00.93 kubelet           
</span></span></code></pre></div><p>kubelet æ•°æ®é»˜è®¤æ‰“å¼€ pprofï¼Œ é€šè¿‡ <a href=https://github.com/google/pprof target=_blank rel=noopener>pprof</a> æ‹¿åˆ°æ•°æ® , é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ–¹å¼</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># pprof -tls_ca {cafile} -tls_key {keyfile} -tls_cert {certfile}</span>
</span></span><span style=display:flex><span> https://<span style=color:#666>{</span>host<span style=color:#666>}</span>:10250/debug/pprof/heap
</span></span></code></pre></div><p>æ‹¿åˆ°æ•°æ®åï¼Œè¿˜å¯ä»¥æ‹¿åˆ°æ­£å¸¸èŠ‚ç‚¹çš„æ•°æ®åšå¯¹æ¯”ï¼Œå¦‚ä¸‹</p><p>æ­£å¸¸ kubelet å†…å­˜ä½¿ç”¨<p class=markdown-image><img src=https://s2.loli.net/2022/04/21/SLKZQjG9Yvdx4Wk.png alt></p></p><p>ä¸æ­£å¸¸ kubelet å†…å­˜ä½¿ç”¨<p class=markdown-image><img src=https://s2.loli.net/2022/04/21/jCefqQ7JARYrSno.png alt></p></p><h2 id=åŸºç¡€-1>åŸºç¡€ <a href=#%e5%9f%ba%e7%a1%80-1 class=anchor>ğŸ”—</a></h2><p>æè¿°ä¸‹ kubelet å½“å‰ç›®å½•å’Œä¼šæ¶‰åŠçš„ä»£ç ç‰‡æ®µ</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>pkg/kubelet/
</span></span><span style=display:flex><span>â”œâ”€â”€ cri #criæ¥å£
</span></span><span style=display:flex><span>â”œâ”€â”€ server # http hanlderå…¥å£
</span></span><span style=display:flex><span>â”œâ”€â”€ stats # å®¹å™¨ cpu/memoryï¼Œfilesystem info æŠ“å–
</span></span><span style=display:flex><span>â”œâ”€â”€ kuberuntime # æ¡¥æ¥å®¹å™¨è¿è¡Œæ—¶ å’Œ kubeletæ“ä½œ
</span></span><span style=display:flex><span>â””â”€â”€ cm #container managerç¼©å†™ï¼Œæ§åˆ¶å™¨å†…å®¹åŒ…æ‹¬ cgroupï¼Œtopology,deviceç­‰
</span></span></code></pre></div><p>å¯ä»¥ç›´æ¥è·¨è¶Šåˆ° cri/ å†…æŸ¥çœ‹ å½“å‰æ¥å£å®ç°ï¼Œæœªè®¾ç½®è¶…æ—¶æ—¶é—´</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a2f;font-weight:700>func</span> (r <span style=color:#666>*</span>remoteRuntimeService) <span style=color:#00a000>ListContainerStats</span>(filter <span style=color:#666>*</span>runtimeapi.ContainerStatsFilter) ([]<span style=color:#666>*</span>runtimeapi.ContainerStats, <span style=color:#0b0;font-weight:700>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#080;font-style:italic>// Do not set timeout, because writable layer stats collection takes time.
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>	<span style=color:#080;font-style:italic>// TODO(random-liu): Should we assume runtime should cache the result, and set timeout here?
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>	ctx, cancel <span style=color:#666>:=</span> <span style=color:#00a000>getContextWithCancel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a2f;font-weight:700>defer</span> <span style=color:#00a000>cancel</span>()
</span></span><span style=display:flex><span>	<span style=color:#080;font-style:italic>// è¿™é‡Œæœªè®¾ç½®è¶…æ—¶æ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>	resp, err <span style=color:#666>:=</span> r.runtimeClient.<span style=color:#00a000>ListContainerStats</span>(ctx, <span style=color:#666>&amp;</span>runtimeapi.ListContainerStatsRequest{
</span></span><span style=display:flex><span>		Filter: filter,
</span></span><span style=display:flex><span>	})
</span></span></code></pre></div><p>å½“å‰è°ƒç”¨é“¾å¤§è‡´å¦‚ä¸‹ , å¯ä»¥çœ‹åˆ°åŠæ—¶å®¢æˆ·ç«¯é€€å‡ºï¼Œä½†æ˜¯ kubelet åˆ° containerd çš„è¿æ¥è¿˜æ˜¯ä¼šä¿æŒï¼Œç›´åˆ°æ‹¿åˆ°æ•°æ®ä¸ºæ­¢<p class=markdown-image><img src=https://s2.loli.net/2022/04/26/bM1swGoBIDTx3gF.png alt></p></p><p>é‚£ä¹ˆè€ƒè™‘å°±æ˜¯å¦‚ä½•å¤ç°è¿™ä¸ªé—®é¢˜ï¼Œä½†é€šè¿‡æµ‹è¯•ä»£ç  [1] å¹¶æœªå¤ç°é—®é¢˜ï¼Œè¿™é‡Œå…¶å®ä¸€ç›´æ˜¯é˜»å¡è°ƒæŸ¥çš„åœ°æ–¹ï¼Œé‚£ä¹ˆä¸å¦¨æ¢ä¸ªæ€è·¯ï¼Œç°ç»§ç»­æŒ–ä¸‹ä¸ºä»€ä¹ˆ containerd æ²¡æœ‰è¿”å›æ•°æ®å‘¢ï¼Ÿ</p><p>åˆ°è¿™é‡Œï¼Œå…¶å®å¯ä»¥å‘ç° kubelet éƒ½é›†ä¸­åœ¨ <code>stats.ListPodStats</code> èŠ±è´¹ä¸Šï¼Œè¯¥è°ƒç”¨ä¼šæœ€ç»ˆåˆ° containerd çš„ Stats æ¥å£ä¸Šï¼Œé‚£ä¹ˆåº”è¯¥ç»§ç»­åˆ†æ containerd ï¼Œè¿™åº”è¯¥æ˜¯äº§ç”Ÿé—®é¢˜çš„æ ¹æœ¬åŸå› </p><h1 id=containerd>containerd <a href=#containerd class=anchor>ğŸ”—</a></h1><p>é€šè¿‡æŠ“å– heap å’Œ goroutine ä¿¡æ¯åˆ†æï¼Œè€Œæˆ‘ä»¬ç¯å¢ƒä¸­ containerd çš„ debug socket å·²ç»æ‰“å¼€ï¼Œæ‰€ä»¥æ¯”è¾ƒæ–¹ä¾¿æ‹¿åˆ° containerd profile ä¿¡æ¯</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#080;font-style:italic># ctr pprof heap &gt; heap.profile</span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic># ctr pprof goroutines &gt; goroutine.profile</span>
</span></span></code></pre></div><p>æ‹¿åˆ°æ•°æ®åï¼Œè¿˜å¯ä»¥æ‹¿åˆ°æ­£å¸¸èŠ‚ç‚¹çš„æ•°æ®åšå¯¹æ¯”</p><p>æ­£å¸¸ containerd å†…å­˜ä½¿ç”¨<p class=markdown-image><img src=https://s2.loli.net/2022/04/21/e1gxopz2HduOiQM.png alt></p></p><p>ä¸æ­£å¸¸ containerd å†…å­˜ä½¿ç”¨<p class=markdown-image><img src=https://s2.loli.net/2022/04/21/qSt6okRhXIEYWUZ.png alt></p></p><p>çœ‹åˆ°çš„æ˜¯ SPDY å†…å­˜æ¶ˆè€—è¾ƒå¤šï¼Œæˆ‘ä»¬çŸ¥é“ SPDY æ˜¯ HTTP/2 å‰èº«ï¼Œä¸»è¦ç”¨äºæµå¼è¿æ¥ï¼Œå½“å‰ä¸»è¦æ˜¯ æ¥å£ exec, attach, portfoward åœ¨æ¥å£ä¸Šï¼Œä»¥ä¸‹æ˜¯ç®€å•å¯¹ exec çš„ä»£ç ç†è§£ , ç„¶åä½¿ç”¨äº† exec ç¡®èƒ½ç¨³å®šå¤ç°é—®é¢˜ï¼Œå¤ç°ä»£ç å¦‚ä¸‹</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#080>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#080></span><span style=color:#b8860b>i</span><span style=color:#666>=</span><span style=color:#666>0</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>NUM</span><span style=color:#666>=</span><span style=color:#b8860b>$1</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>while</span> <span style=color:#666>[</span> <span style=color:#b44>&#34;</span><span style=color:#b8860b>$i</span><span style=color:#b44>&#34;</span> -lt <span style=color:#b8860b>$NUM</span> <span style=color:#666>]</span>; <span style=color:#a2f;font-weight:700>do</span>
</span></span><span style=display:flex><span>   <span style=color:#666>(</span>kubectl <span style=color:#a2f>exec</span> -i test-74cf75b654-gw5hk -- ls /opt<span style=color:#666>)</span>&amp;
</span></span><span style=display:flex><span>   <span style=color:#a2f>let</span> <span style=color:#b44>&#34;i += 1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>done</span>
</span></span></code></pre></div><h2 id=exec-æµç¨‹>exec æµç¨‹ <a href=#exec-%e6%b5%81%e7%a8%8b class=anchor>ğŸ”—</a></h2><p>æµç¨‹éœ€è¦ä» kubelet å¼€å§‹åˆ†æ , é€šè¿‡å‰æ–‡ä¸­å¯¹ kubelet ç›®å½•çš„ç®€å•ä»‹ç»ï¼Œé‚£ä¹ˆå…¥å£è‚¯å®šæ˜¯åœ¨ server ç›®å½•å†…ï¼Œç›´æ¥åˆ°ä¸»é¢˜ Execï¼Œå¯¹åº”å‡½æ•°æ˜¯ <code>getExec(request *restful.Request, response *restful.Response)</code> ï¼Œ è¡Œä¸ºç®€å•æè¿°å¦‚ä¸‹
- æ ¡éªŒå‚æ•°ï¼Œé€šå¸¸ stdout/stderr ä¸º trueï¼Œç›®å‰å¸¸ç”¨çš„æ˜¯ <code>-it</code>ï¼Œä¹Ÿå°±æ˜¯éœ€è¦é…ç½® stdin å’Œ ttry æ˜¯å¦ä¸º true
- æŸ¥è¯¢ pod å½“å‰æ˜¯å¦æ”¯æŒ exec
- æ‰§è¡Œ GetExec è·å– url
- åˆ›å»ºä»£ç†ï¼Œè½¬å‘ apiserver æ•°æ® stdin å’Œ stdout</p><p>cri æœåŠ¡ ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œé‡ç‚¹æè¿° ServerExec
- GetExecï¼šåˆ›å»º url è·¯ç”±ï¼Œå¢åŠ  token <code>host:port/exec/{token}</code>
- ServerExecï¼š åˆ›å»º task å’Œ processï¼Œå¹¶ç»‘å®šæ ‡å‡†è¾“å…¥å’Œè¾“å‡ºç­‰</p><p>ServerExec</p><ul><li>å‡çº§ http ä¸º SPDY streamï¼Œçœ‹ä¸Šå» spdy æ˜¯æ¯”è¾ƒé‡ï¼Œå› ä¸ºè¦è‡³å°‘å»ºç«‹ä¸‰ä¸ª goroutine <code>handler.waitForStreams(streamCh, expectedStreams, expired.C)</code></li><li>æ‰§è¡Œ Exec (åœ¨ streamRuntime å†…)ï¼Œç­‰å¾… process ç»“æŸï¼Œæˆ–è€…ä¸Šæ¸¸é€€å‡º</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#080;font-style:italic>//åˆ›å»ºTaskï¼Œ taskå®é™…æ˜¯ containerd/containerd/task.go ç±»å‹
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>task, err <span style=color:#666>:=</span> container.<span style=color:#00a000>Task</span>(ctx, <span style=color:#a2f;font-weight:700>nil</span>)
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#a2f;font-weight:700>return</span> <span style=color:#a2f;font-weight:700>nil</span>, errors.<span style=color:#00a000>Wrap</span>(err, <span style=color:#b44>&#34;failed to load task&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>pspec <span style=color:#666>:=</span> spec.Process
</span></span><span style=display:flex><span>pspec.Args = opts.cmd
</span></span><span style=display:flex><span>pspec.Terminal = opts.tty
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>if</span> opts.tty {
</span></span><span style=display:flex><span>	oci.<span style=color:#00a000>WithEnv</span>([]<span style=color:#0b0;font-weight:700>string</span>{<span style=color:#b44>&#34;TERM=xterm&#34;</span>})(ctx, <span style=color:#a2f;font-weight:700>nil</span>, <span style=color:#a2f;font-weight:700>nil</span>, spec)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>volatileRootDir <span style=color:#666>:=</span> c.<span style=color:#00a000>getVolatileContainerRootDir</span>(id)
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>var</span> execIO <span style=color:#666>*</span>cio.ExecIO
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>// åˆ›å»ºprocess, å®é™…æ˜¯ containerd/containerd/process.go ç±»å‹
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>process, err <span style=color:#666>:=</span> task.<span style=color:#00a000>Exec</span>(ctx, execID, pspec,
</span></span><span style=display:flex><span>	<span style=color:#a2f;font-weight:700>func</span>(id <span style=color:#0b0;font-weight:700>string</span>) (containerdio.IO, <span style=color:#0b0;font-weight:700>error</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>var</span> err <span style=color:#0b0;font-weight:700>error</span>
</span></span><span style=display:flex><span>		execIO, err = cio.<span style=color:#00a000>NewExecIO</span>(id, volatileRootDir, opts.tty, opts.stdin <span style=color:#666>!=</span> <span style=color:#a2f;font-weight:700>nil</span>)
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>return</span> execIO, err
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>// è·å– process é€€å‡ºç®¡é“
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>exitCh, err <span style=color:#666>:=</span> process.<span style=color:#00a000>Wait</span>(ctx)
</span></span><span style=display:flex><span>err <span style=color:#666>:=</span> process.<span style=color:#00a000>Start</span>(ctx)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>// å°†execIO å’Œ http æµç»‘å®š
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic>// å†…éƒ¨ä¼šåˆ›å»ºåç¨‹ stdin ï¼Œstdout, waitGroup
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span>attachDone <span style=color:#666>:=</span> execIO.<span style=color:#00a000>Attach</span>(cio.AttachOptions{
</span></span><span style=display:flex><span>	Stdin:     opts.stdin,
</span></span><span style=display:flex><span>	Stdout:    opts.stdout,
</span></span><span style=display:flex><span>	Stderr:    opts.stderr,
</span></span><span style=display:flex><span>	Tty:       opts.tty,
</span></span><span style=display:flex><span>	StdinOnce: <span style=color:#a2f;font-weight:700>true</span>,
</span></span><span style=display:flex><span>	CloseStdin: <span style=color:#a2f;font-weight:700>func</span>() <span style=color:#0b0;font-weight:700>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#a2f;font-weight:700>return</span> process.<span style=color:#00a000>CloseIO</span>(ctx, containerd.WithStdinCloser)
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>select</span> {
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>case</span> <span style=color:#666>&lt;-</span>execCtx.<span style=color:#00a000>Done</span>():
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>case</span> exitRes <span style=color:#666>:=</span> <span style=color:#666>&lt;-</span>exitCh:
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™é‡Œæ˜¯é˜»å¡åœ¨è°ƒç”¨ exec ä¸Šï¼Œä½†æ˜¯å’Œ cpuAndMemoryStats å¹¶æ— å…³ç³»ï¼Œå¦‚æœæ˜¯æœ‰å…³ç³»ï¼Œé‚£ä¹ˆä¹Ÿåªæœ‰åœ¨ shim è¿™ä¸€çº§ï¼Œå› ä¸ºéƒ½è¦è°ƒç”¨ shim çš„ rpc æ¥å£</p><h1 id=shim>shim <a href=#shim class=anchor>ğŸ”—</a></h1><p>å½“å‰ runc ä½¿ç”¨çš„ shim æ˜¯ containerd-shim-runc-v2, åœ¨å†…ç½®çš„ shim server ä¸Šæœ‰ä¸€ä¸ªæ–¹ä¾¿è°ƒè¯•çš„æ–¹å¼ï¼Œå‘é€ USER1 ä¿¡å· å¯ä»¥è·å– goroutines ä¿¡æ¯ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#080;font-style:italic>// runtime/v2/shim/shim_unix.go
</span></span></span><span style=display:flex><span><span style=color:#080;font-style:italic></span><span style=color:#a2f;font-weight:700>func</span> <span style=color:#00a000>setupDumpStacks</span>(dump <span style=color:#a2f;font-weight:700>chan</span><span style=color:#666>&lt;-</span> os.Signal) {
</span></span><span style=display:flex><span>	signal.<span style=color:#00a000>Notify</span>(dump, syscall.SIGUSR1)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>// å‘é€ USER1 ä¿¡å·
</span></span><span style=display:flex><span><span style=color:#a2f>kill</span> -10 <span style=color:#666>{</span>pid<span style=color:#666>}</span>
</span></span><span style=display:flex><span>// è·å–containerd æ—¥å¿—ï¼Œè·å–BEGIN goroutine stack dump æ—¥å¿—
</span></span><span style=display:flex><span>journalctl -eu containerd &gt;contaienrd.log
</span></span></code></pre></div><p>æŸ¥çœ‹ shim çš„ goroutines ä¿¡æ¯ï¼Œå› ä¸ºå’Œ ttrpc æœ‰å…³ï¼Œé‚£ç›´æ¥æ‰¾ ttrpc ä¿¡æ¯å§ï¼Œå¯ä»¥å‘ç°ä»¥ä¸‹ä¿¡æ¯ï¼Œè¿™é‡Œæ˜¾ç„¶ä¸åº”è¯¥æœ‰é‚£ä¹ˆå¤š goroutine hang åœ¨ <code>vendor/github.com/containerd/ttrpc/server.go:444</code> è¡Œï¼Œé‚£ä¹ˆç»§ç»­çœ‹ä¸‹ ttrpc æœ‰å…³å®ç°å‘¢</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ cat shim.goroutine.profile |grep ttrpc/server | sort |uniq -c |sort
</span></span><span style=display:flex><span>      1 	vendor/github.com/containerd/ttrpc/server.go:362 +0x149
</span></span><span style=display:flex><span>      1 	vendor/github.com/containerd/ttrpc/server.go:404 +0x5ee
</span></span><span style=display:flex><span>      1 	vendor/github.com/containerd/ttrpc/server.go:431 +0x41a
</span></span><span style=display:flex><span>      1 	vendor/github.com/containerd/ttrpc/server.go:459 +0x6bd
</span></span><span style=display:flex><span>      1 	vendor/github.com/containerd/ttrpc/server.go:87 +0x107
</span></span><span style=display:flex><span>      2 	vendor/github.com/containerd/ttrpc/server.go:127 +0x2a7
</span></span><span style=display:flex><span>      2 	vendor/github.com/containerd/ttrpc/server.go:332 +0x2ce
</span></span><span style=display:flex><span>      6 	vendor/github.com/containerd/ttrpc/server.go:438 +0xf2
</span></span><span style=display:flex><span>    164 	vendor/github.com/containerd/ttrpc/server.go:444 +0x245
</span></span><span style=display:flex><span>    169 	vendor/github.com/containerd/ttrpc/server.go:434 +0x63f
</span></span></code></pre></div><h2 id=ttrpc>ttrpc <a href=#ttrpc class=anchor>ğŸ”—</a></h2><p><strong>reqCh, respCh, msgCh å‡ä¸ºéç¼“å­˜ channel</strong></p><p>æœåŠ¡ç«¯å¤§è‡´å¦‚ä¸‹<p class=markdown-image><img src=https://s2.loli.net/2022/04/21/AwBVbSm9kuL2U1h.png alt></p></p><ul><li>æ¯åˆ›å»ºä¸€ä¸ªè¿æ¥ï¼Œ éƒ½ä¼šäº§ç”Ÿ 2 ä¸ªåç¨‹æ¥å¤„ç†ä¼šè¯</li><li>recv åç¨‹ï¼š ä»å®¢æˆ·ç«¯è¯»å–æ•°æ®ï¼Œå¹¶æ ¡éªŒåˆæ³•æ€§å†™å…¥ Channel ä¸­ï¼Œäº¤ç»™ worker æ¥å¤„ç†</li><li>worker åç¨‹ï¼šæ”¶åˆ°è¯·æ±‚åï¼Œ<strong>å¹¶å‘åˆ›å»ºåç¨‹</strong>è°ƒç”¨æ³¨å†Œçš„æœåŠ¡</li></ul><p>1.0.1 ç‰ˆæœ¬ å®¢æˆ·ç«¯å¤§è‡´å¦‚ä¸‹<p class=markdown-image><img src=https://s2.loli.net/2022/04/21/WjuCD8eSObodZwY.png alt></p></p><ul><li>å’ŒæœåŠ¡ç«¯ç±»ä¼¼ï¼Œå·¥ä½œåç¨‹åŒæ—¶å¤„ç†æ¥æ”¶å’Œå‘é€è¯·æ±‚ï¼Œ</li><li>é‡ç‚¹æ˜¯ <strong>å‘é€å’Œæ¥æ”¶æ˜¯åœ¨ä¸€ä¸ªåç¨‹ä¸­å¤„ç†ï¼Œå¹¶é€šè¿‡å†…éƒ¨ waitCall æ¥åŒæ­¥æ•°æ®</strong></li></ul><p>å‘ç”Ÿæ­»é”çš„æƒ…å†µæ˜¯ å®¢æˆ·ç«¯ é˜»å¡åœ¨ send è¿‡ç¨‹ï¼Œæ­¤æ—¶å› ä¸ºæ— æ³•å¤„ç†è¿”å›çš„ Resp ä¿¡æ¯ï¼Œç»§è€Œå¯¼è‡´æœåŠ¡ç«¯çš„åº”ç­”æ•°æ®é˜»å¡åœ¨ net write buffer ä¸­
ä»€ä¹ˆæƒ…å†µä¼šå¯¼è‡´ send é˜»å¡ï¼Œç½‘ç»œå‘é€è¿‡ç¨‹æœ‰ä»¥ä¸‹æƒ…å†µ , è¿›ç¨‹å°†æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å­˜åŒºï¼Œä¹‹åç”±è½¯ä¸­æ–­å‘é€å‡ºå»ï¼Œè¯¥æ§åˆ¶å†™ç¼“å­˜å¤§å°ä¸º tcp_wmem, å†…æ ¸å‚æ•°é…ç½®ä¸º <code>4096 16384 4194304</code></p><p>é’ˆå¯¹ä¸Šè¿°å¯¼è‡´æ­»é”çš„æƒ…å†µï¼Œæœ‰ä¸€ä¸ªç›¸å…³ patch[2] è§£å†³ï¼Œè¯¥ patch ä¿®æ”¹æ–¹å¼å¦‚ä¸‹å›¾</p><p>1.1.0 ç‰ˆæœ¬ å®¢æˆ·ç«¯<p class=markdown-image><img src=https://s2.loli.net/2022/04/21/Uc5GHopBs1brWDA.png alt></p></p><p>å‘é€å’Œæ¥æ”¶ éƒ½é€šè¿‡ä¸åŒçš„åç¨‹å¤„ç†ï¼Œä¸å†å‡ºç°ç«äº‰æƒ…å†µå‘ç”Ÿ</p><h1 id=å‚è€ƒ>å‚è€ƒ <a href=#%e5%8f%82%e8%80%83 class=anchor>ğŸ”—</a></h1><p>[1]. <a href=https://gist.github.com/yylt/0d3f2d554fa7eddd9cafe406ef0c9d75 target=_blank rel=noopener>https://gist.github.com/yylt/0d3f2d554fa7eddd9cafe406ef0c9d75</a>
[2]. <a href=https://github.com/containerd/ttrpc/pull/94 target=_blank rel=noopener>https://github.com/containerd/ttrpc/pull/94</a></p></div><div class=tags><a href=https://easystack.github.io/tags/containerd>containerd</a>
<a href=https://easystack.github.io/tags/kubelete>kubelete</a></div><div id=comment></div></section></main><footer id=footer><div id=social><a class=symbol href=easystack rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg></a></div><div class=copyright>Â© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>easystack</div><div class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-cactus-plus>nodejh</a></div></footer></body></html>